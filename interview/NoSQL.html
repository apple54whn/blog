<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>NoSQL | Conanan</title>
    <meta name="description" content="apple54whn的文档,conanan的文档">
    <link rel="manifest" href="/manifest.json">
    
    <link rel="preload" href="/assets/css/0.styles.2be5de51.css" as="style"><link rel="preload" href="/assets/js/app.d8cb9cb7.js" as="script"><link rel="preload" href="/assets/js/2.3b02efce.js" as="script"><link rel="preload" href="/assets/js/16.8851cfe7.js" as="script"><link rel="prefetch" href="/assets/js/10.f8026447.js"><link rel="prefetch" href="/assets/js/11.19d3094c.js"><link rel="prefetch" href="/assets/js/12.04fab03d.js"><link rel="prefetch" href="/assets/js/13.96ecc411.js"><link rel="prefetch" href="/assets/js/14.076625fd.js"><link rel="prefetch" href="/assets/js/15.663af154.js"><link rel="prefetch" href="/assets/js/17.94a979e8.js"><link rel="prefetch" href="/assets/js/18.923289d1.js"><link rel="prefetch" href="/assets/js/19.95d7a536.js"><link rel="prefetch" href="/assets/js/20.2b3c6974.js"><link rel="prefetch" href="/assets/js/21.661409df.js"><link rel="prefetch" href="/assets/js/22.ca5f0d41.js"><link rel="prefetch" href="/assets/js/23.6de8e3ef.js"><link rel="prefetch" href="/assets/js/24.364196f3.js"><link rel="prefetch" href="/assets/js/3.14089e0c.js"><link rel="prefetch" href="/assets/js/4.0b088ce7.js"><link rel="prefetch" href="/assets/js/5.ecab5bba.js"><link rel="prefetch" href="/assets/js/6.020ec481.js"><link rel="prefetch" href="/assets/js/7.b7b1e947.js"><link rel="prefetch" href="/assets/js/8.d09e1b35.js"><link rel="prefetch" href="/assets/js/9.5ceebd53.js">
    <link rel="stylesheet" href="/assets/css/0.styles.2be5de51.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Conanan</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/interview/" class="nav-link router-link-active">面试总结</a></div><div class="nav-item"><a href="/Java/" class="nav-link">Java</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Database</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>SQL</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/SQL/MySQL/" class="nav-link">MySQL</a></li><li class="dropdown-subitem"><a href="/SQL/Oracle/" class="nav-link">Oracle</a></li><li class="dropdown-subitem"><a href="/SQL/MyBatis/" class="nav-link">MyBatis</a></li><li class="dropdown-subitem"><a href="/SQL/Spring Data JPA/" class="nav-link">Spring Data JPA</a></li></ul></li><li class="dropdown-item"><h4>NoSQL</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/NoSQL/Redis/" class="nav-link">Redis</a></li><li class="dropdown-subitem"><a href="/NoSQL/MongoDB/" class="nav-link">MongoDB</a></li><li class="dropdown-subitem"><a href="/NoSQL/Elasticsearch/" class="nav-link">Elasticsearch</a></li></ul></li></ul></div></div> <a href="https://github.com/apple54whn/docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/interview/" class="nav-link router-link-active">面试总结</a></div><div class="nav-item"><a href="/Java/" class="nav-link">Java</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Database</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>SQL</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/SQL/MySQL/" class="nav-link">MySQL</a></li><li class="dropdown-subitem"><a href="/SQL/Oracle/" class="nav-link">Oracle</a></li><li class="dropdown-subitem"><a href="/SQL/MyBatis/" class="nav-link">MyBatis</a></li><li class="dropdown-subitem"><a href="/SQL/Spring Data JPA/" class="nav-link">Spring Data JPA</a></li></ul></li><li class="dropdown-item"><h4>NoSQL</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/NoSQL/Redis/" class="nav-link">Redis</a></li><li class="dropdown-subitem"><a href="/NoSQL/MongoDB/" class="nav-link">MongoDB</a></li><li class="dropdown-subitem"><a href="/NoSQL/Elasticsearch/" class="nav-link">Elasticsearch</a></li></ul></li></ul></div></div> <a href="https://github.com/apple54whn/docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/interview/" class="sidebar-link">Java 基础</a></li><li><a href="/interview/集合.html" class="sidebar-link">集合</a></li><li><a href="/interview/多线程.html" class="sidebar-link">多线程</a></li><li><a href="/interview/SQL.html" class="sidebar-link">数据库</a></li><li><a href="/interview/NoSQL.html" class="active sidebar-link">NoSQL</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/interview/NoSQL.html#redis-6379" class="sidebar-link">Redis-6379</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/interview/NoSQL.html#什么是redis？用处？" class="sidebar-link">什么是Redis？用处？</a></li><li class="sidebar-sub-header"><a href="/interview/NoSQL.html#redis和-memcached-的区别？" class="sidebar-link">Redis和 memcached 的区别？</a></li><li class="sidebar-sub-header"><a href="/interview/NoSQL.html#redis-常见数据结构以及使用场景分析" class="sidebar-link">Redis 常见数据结构以及使用场景分析</a></li><li class="sidebar-sub-header"><a href="/interview/NoSQL.html#redis-设置过期时间" class="sidebar-link">Redis 设置过期时间</a></li><li class="sidebar-sub-header"><a href="/interview/NoSQL.html#redis-内存淘汰机制" class="sidebar-link">Redis 内存淘汰机制</a></li><li class="sidebar-sub-header"><a href="/interview/NoSQL.html#redis-持久化机制" class="sidebar-link">Redis 持久化机制</a></li><li class="sidebar-sub-header"><a href="/interview/NoSQL.html#缓存雪崩和缓存穿透问题解决方案" class="sidebar-link">缓存雪崩和缓存穿透问题解决方案</a></li><li class="sidebar-sub-header"><a href="/interview/NoSQL.html#redis-cluster" class="sidebar-link">Redis-Cluster</a></li><li class="sidebar-sub-header"><a href="/interview/NoSQL.html#redis-为什么是单线程的" class="sidebar-link">Redis 为什么是单线程的</a></li></ul></li></ul></li><li><a href="/interview/Java Web.html" class="sidebar-link">Java Web</a></li><li><a href="/interview/Spring.html" class="sidebar-link">Spring</a></li><li><a href="/interview/Tools.html" class="sidebar-link">系统、工具</a></li><li><a href="/interview/项目技术.html" class="sidebar-link">项目技术</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="nosql"><a href="#nosql" aria-hidden="true" class="header-anchor">#</a> NoSQL</h1> <h2 id="redis-6379"><a href="#redis-6379" aria-hidden="true" class="header-anchor">#</a> Redis-6379</h2> <h3 id="什么是redis？用处？"><a href="#什么是redis？用处？" aria-hidden="true" class="header-anchor">#</a> 什么是Redis？用处？</h3> <p>Redis是一个开源<strong>的高性能key-value数据库</strong>。直接从内存中读取数据，<strong>减少数据库访问压力</strong>，<strong>承受并发能力强</strong>；应用场景如下：</p> <ul><li><strong>缓存</strong>（首页缓存、数据查询等）</li> <li><strong>消息中间件</strong></li> <li>计数器/<strong>排行榜</strong></li></ul> <h3 id="redis和-memcached-的区别？"><a href="#redis和-memcached-的区别？" aria-hidden="true" class="header-anchor">#</a> Redis和 memcached 的区别？</h3> <ul><li>Redis支持<strong>丰富的数据类型</strong>（5个）；memcached仅支持简单的数据类型String</li> <li>Redis<strong>支持数据持久化</strong>，可以将内存中数据保存到磁盘中，重启后再次加载使用；memcached不支持</li> <li>Redis<strong>原生支持集群（cluster）</strong>；memcached没有原生的方式</li></ul> <h3 id="redis-常见数据结构以及使用场景分析"><a href="#redis-常见数据结构以及使用场景分析" aria-hidden="true" class="header-anchor">#</a> Redis 常见数据结构以及使用场景分析</h3> <ul><li><p>String：可以是String、数字。常规<strong>计数</strong>：微博数、粉丝数</p> <p>set / get / del</p></li> <li><p>Hash：适合存储<strong>对象</strong>数据：购物车、商品</p> <p>hset / hget / hgetall / hdel</p></li> <li><p>List：内部是链表：<strong>消息列表（高性能分页，下拉不断分页）</strong>、关注列表、粉丝列表</p> <p>l/rpush / lrange / l/rpop</p></li> <li><p>Set：与List类似，去重。基于 set 轻易实现<strong>交集、并集、差集</strong>的操作。如<strong>共同关注</strong>、共同粉丝</p> <p><code>sinterstore key1 key2 key3</code>将交集存在key1内</p> <p>sadd / smembers / srem</p></li> <li><p>ZSet：相比Set多个<strong>score权重</strong>，按score排序。直播中<strong>礼物排行榜、在线用户列表</strong></p> <p>zadd / zrange / zrem</p></li></ul> <h3 id="redis-设置过期时间"><a href="#redis-设置过期时间" aria-hidden="true" class="header-anchor">#</a> Redis 设置过期时间</h3> <blockquote><p>expire  /ɪkˈspaɪr/ 到期，期满；结束</p></blockquote> <p>set key 的时候，都可以给一个 <strong>expire time</strong>，就是过期时间。时间到后删除方式如下：</p> <ul><li><strong>定期删除</strong>：redis默认是<strong>每隔 100ms 就随机抽取</strong>一些设置了过期时间的key，检查其是否过期，如果过期就删除。注意这里是随机抽取的。为什么要随机呢？你想一想假如 redis 存了几十万个 key ，每隔100ms就遍历所有的设置过期时间的 key 的话，就会给 CPU 带来很大的负载！</li> <li><strong>惰性删除</strong>：定期删除可能会导致很多过期 key 到了时间并没有被删除掉。所以就有了惰性删除。假如你的过期key，靠定期删除没有被删除掉，还停留在内存里，除非你的系统去查一下那个 key，才会被redis给删除掉，这就是所谓的惰性删除</li></ul> <h3 id="redis-内存淘汰机制"><a href="#redis-内存淘汰机制" aria-hidden="true" class="header-anchor">#</a> Redis 内存淘汰机制</h3> <p>但是若有的key没有被定期删除，也没有执行惰性删除。此时需要用到 Redis 内存淘汰机制</p> <blockquote><p>MySQL里有2000w数据，Redis中只存20w的数据，如何保证Redis中的数据都是<strong>热点数据</strong>？</p></blockquote> <p>redis 提供 6 种数据淘汰策略：</p> <ul><li>volatile-lru：从已设置过期时间的数据集（server.db[i].expires）中挑选<strong>最近最少使用</strong>的数据淘汰</li> <li>volatile-ttl：从已设置过期时间的数据集（server.db[i].expires）中挑选<strong>将要过期</strong>的数据淘汰</li> <li>volatile-random：从已设置过期时间的数据集（server.db[i].expires）中<strong>任意选择</strong>数据淘汰</li> <li>allkeys-lru：当<strong>内存不足以容纳新写入数据时</strong>，在键空间中，<strong>移除最近最少使用的key</strong>（这个是最常用的）.</li> <li>allkeys-random：从数据集（server.db[i].dict）中任意选择数据淘汰</li> <li>no-eviction：禁止驱逐数据，也就是说当内存不足以容纳新写入数据时，新写入操作会报错。这个应该没人使用吧！</li></ul> <h3 id="redis-持久化机制"><a href="#redis-持久化机制" aria-hidden="true" class="header-anchor">#</a> Redis 持久化机制</h3> <ul><li><p><strong>RDB</strong>（快照，snapshotting）：<strong>默认</strong>方式，不需要进行配置。<strong>在一定的间隔时间中，检测key的变化情况</strong>，然后持久化数据</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token comment">#   after 900 sec (15 min) if at least 1 key changed</span>
save <span class="token number">900</span> <span class="token number">1</span>
<span class="token comment">#   after 300 sec (5 min) if at least 10 keys changed</span>
save <span class="token number">300</span> <span class="token number">10</span>
<span class="token comment">#   after 60 sec if at least 10000 keys changed</span>
save <span class="token number">60</span> <span class="token number">10000</span>
</code></pre></div></li> <li><p><strong>AOF</strong>（append-only ﬁle，只追加文件）：日志记录方式，可以每一次命令操作后，持久化数据。编辑redis.windwos.conf文件</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code>appendonly no（关闭aof） <span class="token operator">--</span><span class="token operator">&gt;</span> appendonly yes （开启aof）

<span class="token comment"># appendfsync always ： 每一次操作都进行持久化</span>
appendfsync everysec ： 每隔一秒进行一次持久化
<span class="token comment"># appendfsync no	 ： 不进行持久化</span>
</code></pre></div></li></ul> <h3 id="缓存雪崩和缓存穿透问题解决方案"><a href="#缓存雪崩和缓存穿透问题解决方案" aria-hidden="true" class="header-anchor">#</a> 缓存雪崩和缓存穿透问题解决方案</h3> <ul><li>缓存雪崩：缓存同一时间大面积的失效，所以，后面的请求都会落到数据库上，造成数据库短时间内承受大量请求而崩掉。
<ul><li>事前：尽量保证整个 <strong>redis 集群的高可用性</strong>，发现机器宕机尽快补上。选择合适的<strong>内存淘汰策略</strong>。</li> <li>事中：本地 ehcache缓存 + hystrix限流&amp;降级，避免MySQL崩掉</li> <li>事后：利用 redis 持久化机制保存的数据尽快恢复缓存</li></ul></li></ul> <h3 id="redis-cluster"><a href="#redis-cluster" aria-hidden="true" class="header-anchor">#</a> Redis-Cluster</h3> <p>Redis-Cluster采用<strong>无中心结构</strong>，每个节点保存数据和整个集群状态,每个节点都和其他所有节点连接</p> <ul><li><p><strong>分布存储机制-槽</strong></p> <ul><li><p>redis-cluster 把所有的物理节点映射到[0-16383]slot（槽） 上，cluster 负责维护</p></li> <li><p>Redis 集群中内置了 16384 个哈希槽，当需要在 Redis 集群中放置一个 key-value 时，redis 先对 key 使用 crc16 算法算出一个结果，然后把结果对 16384 求余数，这样每个key 都会对应一个编号在 0-16383 之间的哈希槽，redis 会根据节点数量大致均等的将哈希槽映射到不同的节点。</p> <p>例如三个节点：槽分布的值如下：SERVER1:  0-5460；SERVER2:  5461-10922；SERVER3:  10923-16383</p></li></ul></li> <li><p><strong>容错机制-投票</strong></p> <ul><li><p>选举过程是集群中所有master参与,如果半数以上master节点与故障节点通信超过(cluster-node-timeout)，认为该节点故障，自动触发故障转移操作，采用<strong>投票机制</strong>故障节点对应的从节点自动升级为主节点</p></li> <li><p>什么时候整个集群不可用(cluster_state:fail)?</p> <p>如果集群任意master挂掉，且当前master没有slave，集群进入fail状态，也可以理解成集群的slot映射[0-16383]不完成时进入fail状态.。</p></li></ul></li></ul> <h3 id="redis-为什么是单线程的"><a href="#redis-为什么是单线程的" aria-hidden="true" class="header-anchor">#</a> Redis 为什么是单线程的</h3> <ul><li><p>因为<strong>CPU</strong>不是Redis的瓶颈，<strong>瓶颈可能是内存或网络带宽</strong>！</p></li> <li><p>异步非阻塞 IO，避免线程切换及锁的资源损耗</p></li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/apple54whn/docs/edit/master/docs/interview/NoSQL.md" target="_blank" rel="noopener noreferrer">编辑文档！</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新时间: </span> <span class="time">2019-6-2 7:01:13 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/interview/SQL.html" class="prev">
          数据库
        </a></span> <span class="next"><a href="/interview/Java Web.html">
          Java Web
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.d8cb9cb7.js" defer></script><script src="/assets/js/2.3b02efce.js" defer></script><script src="/assets/js/16.8851cfe7.js" defer></script>
  </body>
</html>
